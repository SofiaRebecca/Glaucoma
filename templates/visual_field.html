<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Field Test</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* Countdown Modal */
        .modal {
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #2d3436;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #0984e3;
        }

        #countdown-number {
            font-size: 8rem;
            font-weight: bold;
            color: #0984e3;
            margin: 20px 0;
            text-shadow: 0 0 20px #0984e3;
        }
        .test-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .visual-field-grid {
            position: relative;
            width: 600px;
            height: 600px;
            margin: 0 auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .test-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .test-letter {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: white;
            opacity: 0;
            transition: opacity 0.1s;
            cursor: pointer;
            z-index: 10;
            user-select: none;
            font-family: 'Courier New', monospace;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .visual-field-grid {
                width: 95vw;
                height: 95vh;
            }

            .test-point {
                width: 25px;
                height: 25px;
            }

            .test-letter {
                font-size: 28px;
            }

            .instructions {
                padding: 15px;
                font-size: 14px;
            }
        }

        .test-point.active {
            opacity: 1;
            animation: pulse 0.5s ease-in-out;
            background: #ffffff;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .test-point.clicked {
            background: #28a745;
            border-color: #28a745;
        }

        .fixation-point {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: red;
            font-size: 24px;
            z-index: 10;
            font-weight: bold;
        }

        .instructions {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 10px;
            max-width: 600px;
        }

        .test-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
        }

        .controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
        }

        .controls.show {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }

        .fullscreen-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 123, 255, 0.8);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .fullscreen-btn:hover {
            background: rgba(0, 123, 255, 1);
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div id="instructions" class="instructions">
        <h2 class="mb-4">
            <i class="fas fa-eye me-2"></i>
            Visual Field Test
        </h2>
        <p class="mb-4">
            This test evaluates your peripheral vision by detecting points of light in your visual field.
        </p>
        <div class="mb-4">
            <h5>Instructions:</h5>
            <ul class="text-start">
                <li>Keep your eyes focused on the red center point at all times</li>
                <li>Click when you see a white point appear in your peripheral vision</li>
                <li>Do not move your eyes from the center point</li>
                <li>The test will show points at different locations and intensities</li>
                <li>Click as soon as you see each point</li>
            </ul>
        </div>
        <button class="btn btn-primary btn-lg" onclick="startFullscreenTest()">
            <i class="fas fa-play me-2"></i>
            Start Test
        </button>
    </div>

    <div id="test-container" class="test-container" style="display: none;">
        <div class="test-info">
            <div>Point: <span id="current-point">0</span> / 48</div>
            <div>Detected: <span id="detected-count">0</span></div>
            <div>Accuracy: <span id="accuracy">0%</span></div>
        </div>

        <button class="fullscreen-btn" onclick="toggleTestFullscreen()" title="Toggle Fullscreen">
            <i class="fas fa-expand" id="vf-fullscreen-icon"></i>
        </button>

        <div class="visual-field-grid">
            <div class="fixation-point">+</div>
            <!-- Grid points will be generated by JavaScript -->
        </div>

        <div class="controls" id="controls">
            <button class="btn btn-warning" onclick="skipPoint()">
                <i class="fas fa-forward me-2"></i>
                Skip Point
            </button>
            <button class="btn btn-danger" onclick="endTest()">
                <i class="fas fa-stop me-2"></i>
                End Test
            </button>
        </div>
    </div>

    <div class="modal" id="countdown-modal" style="display: none;">
        <div class="modal-content">
            <h2 class="mb-4">Test starting in...</h2>
            <div id="countdown-number">3</div>
        </div>
    </div>

    <script>
        class VisualFieldTest {
            constructor() {
                this.currentPoint = 0;
                this.totalPoints = 48;
                this.detectedCount = 0;
                this.testData = [];
                this.startTime = new Date();
                this.patientName = localStorage.getItem('patientName') || 'Unknown';
                this.isTestActive = false;
                this.currentTimeout = null;

                this.setupGrid();
            }

            setupGrid() {
                const grid = document.querySelector('.visual-field-grid');

                // Create 8x6 grid of test points
                for (let row = 0; row < 6; row++) {
                    for (let col = 0; col < 8; col++) {
                        const point = document.createElement('div');
                        point.className = 'test-point';
                        point.dataset.row = row;
                        point.dataset.col = col;
                        point.dataset.index = row * 8 + col;

                        point.addEventListener('click', () => this.pointClicked(point));

                        grid.appendChild(point);
                    }
                }
            }

            start() {
                document.getElementById('instructions').style.display = 'none';
                document.getElementById('test-container').style.display = 'block';
                document.getElementById('controls').classList.add('show');

                this.isTestActive = true;
                this.startTime = new Date();
                this.showNextPoint();
            }

            showNextPoint() {
                if (this.currentPoint >= this.totalPoints || !this.isTestActive) {
                    this.completeTest();
                    return;
                }

                // Clear previous point
                document.querySelectorAll('.test-point.active').forEach(p => {
                    p.classList.remove('active');
                });

                // Show random point
                const points = document.querySelectorAll('.test-point');
                const randomIndex = Math.floor(Math.random() * points.length);
                const point = points[randomIndex];

                point.classList.add('active');
                this.currentActivePoint = point;
                this.pointStartTime = Date.now();

                // Update UI
                document.getElementById('current-point').textContent = this.currentPoint + 1;
                document.getElementById('accuracy').textContent = 
                    this.currentPoint > 0 ? Math.round((this.detectedCount / this.currentPoint) * 100) + '%' : '0%';

                // Auto-advance after 3 seconds
                this.currentTimeout = setTimeout(() => {
                    this.pointMissed();
                }, 3000);
            }

            pointClicked(clickedPoint) {
                if (!this.isTestActive || !this.currentActivePoint) return;

                clearTimeout(this.currentTimeout);

                const reactionTime = Date.now() - this.pointStartTime;
                const isCorrect = clickedPoint === this.currentActivePoint;

                if (isCorrect) {
                    this.detectedCount++;
                    clickedPoint.classList.add('clicked');
                    document.getElementById('detected-count').textContent = this.detectedCount;
                }

                this.recordResponse(isCorrect, reactionTime);

                this.currentActivePoint.classList.remove('active');
                this.currentActivePoint = null;
                this.currentPoint++;

                setTimeout(() => this.showNextPoint(), 500);
            }

            pointMissed() {
                if (!this.isTestActive || !this.currentActivePoint) return;

                this.recordResponse(false, 3000);

                this.currentActivePoint.classList.remove('active');
                this.currentActivePoint = null;
                this.currentPoint++;

                setTimeout(() => this.showNextPoint(), 500);
            }

            recordResponse(detected, reactionTime) {
                const point = this.currentActivePoint;

                this.testData.push({
                    pointIndex: this.currentPoint,
                    row: parseInt(point.dataset.row),
                    col: parseInt(point.dataset.col),
                    detected: detected,
                    reactionTime: reactionTime,
                    timestamp: new Date()
                });
            }

            skipPoint() {
                if (!this.isTestActive) return;

                clearTimeout(this.currentTimeout);
                this.pointMissed();
            }

            endTest() {
                if (confirm('Are you sure you want to end the test?')) {
                    this.isTestActive = false;
                    clearTimeout(this.currentTimeout);
                    this.completeTest();
                }
            }

            completeTest() {
                this.isTestActive = false;
                const endTime = new Date();
                const duration = Math.round((endTime - this.startTime) / 1000);

                const accuracy = this.currentPoint > 0 ? (this.detectedCount / this.currentPoint) * 100 : 0;

                const results = {
                    patient_name: this.patientName,
                    test_name: 'visual_field',
                    duration: duration,
                    start_time: this.startTime.toISOString(),
                    end_time: endTime.toISOString(),
                    total_points: this.currentPoint,
                    correct_points: this.detectedCount,
                    accuracy: accuracy,
                    points_tested: this.testData.length,
                    sensitivity_map: this.testData,
                    defects_detected: this.calculateDefects()
                };

                this.saveResults(results);
            }

            calculateDefects() {
                // Simple defect detection based on missed points in clusters
                let defects = 0;
                const missedPoints = this.testData.filter(p => !p.detected);

                // Count clusters of missed points as defects
                for (let i = 0; i < missedPoints.length; i++) {
                    const point = missedPoints[i];
                    const neighbors = missedPoints.filter(p => 
                        Math.abs(p.row - point.row) <= 1 && 
                        Math.abs(p.col - point.col) <= 1 && 
                        p !== point
                    );

                    if (neighbors.length >= 2) {
                        defects++;
                    }
                }

                return defects;
            }

            saveResults(results) {
                fetch('/api/save_test_result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(results)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Test completed successfully!\nAccuracy: ${results.accuracy.toFixed(1)}%\nPoints detected: ${results.correct_points}/${results.total_points}\n\nReturning to test dashboard...`);
                        setTimeout(() => {
                            window.location.href = '/patient';
                        }, 2000);
                    } else {
                        alert('Error saving results: ' + data.message);
                        // Still return to dashboard even if save failed
                        setTimeout(() => {
                            window.location.href = '/patient';
                        }, 3000);
                    }
                })
                .catch(error => {
                    console.error('Error saving results:', error);
                    alert('Error saving results. Please try again.');
                });
            }
        }

        let test = null;

        function startTestWithCountdown() {
            showCountdown(() => {
                document.getElementById('instructions').style.display = 'none';
                document.getElementById('test-container').style.display = 'block';

                if (!test) {
                    test = new VisualFieldTest();
                }
                test.start();
            });
        }

        function startFullscreenTest() {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().then(() => {
                    setTimeout(() => {
                        showCountdown(() => {
                            document.getElementById('instructions').style.display = 'none';
                            document.getElementById('test-container').style.display = 'block';

                            if (!test) {
                                test = new VisualFieldTest();
                            }
                            test.start();
                        });
                    }, 500);
                }).catch(err => {
                    console.log('Fullscreen failed:', err);
                    startTestWithCountdown();
                });
            } else {
                startTestWithCountdown();
            }
        }

        function showCountdown(callback) {
            const modal = document.getElementById('countdown-modal');
            const countdownNumber = document.getElementById('countdown-number');
            let count = 3;

            modal.style.display = 'flex';
            countdownNumber.textContent = count;

            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownNumber.textContent = count;
                } else {
                    countdownNumber.textContent = 'GO!';
                    setTimeout(() => {
                        modal.style.display = 'none';
                        clearInterval(countdownInterval);
                        callback();
                    }, 500);
                }
            }, 1000);
        }

        function startTest() {
            document.getElementById('instructions').style.display = 'none';
            document.getElementById('test-container').style.display = 'block';

            if (!test) {
                test = new VisualFieldTest();
            }
            test.start();
        }

        function skipPoint() {
            if (test) {
                test.skipPoint();
            }
        }

        function endTest() {
            if (test) {
                test.endTest();
            }
        }

        function toggleTestFullscreen() {
            const elem = document.documentElement;
            const icon = document.getElementById('vf-fullscreen-icon');

            if (!document.fullscreenElement && !document.webkitFullscreenElement && 
                !document.mozFullScreenElement && !document.msFullscreenElement) {
                
                const request = elem.requestFullscreen || 
                              elem.webkitRequestFullscreen || 
                              elem.mozRequestFullScreen || 
                              elem.msRequestFullscreen;
                
                if (request) {
                    request.call(elem).catch(err => {
                        console.log('Fullscreen failed:', err);
                    });
                }
            } else {
                const exit = document.exitFullscreen || 
                           document.webkitExitFullscreen || 
                           document.mozCancelFullScreen || 
                           document.msExitFullscreen;
                
                if (exit) {
                    exit.call(document);
                }
            }
        }

        // Update fullscreen icon
        function updateVFFullscreenIcon() {
            const icon = document.getElementById('vf-fullscreen-icon');
            const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || 
                               document.mozFullScreenElement || document.msFullscreenElement;
            
            if (icon) {
                icon.className = isFullscreen ? 'fas fa-compress' : 'fas fa-expand';
            }
        }

        document.addEventListener('fullscreenchange', updateVFFullscreenIcon);
        document.addEventListener('webkitfullscreenchange', updateVFFullscreenIcon);
        document.addEventListener('mozfullscreenchange', updateVFFullscreenIcon);
        document.addEventListener('MSFullscreenChange', updateVFFullscreenIcon);

        // Handle escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.fullscreenElement) {
                    toggleTestFullscreen();
                } else if (confirm('Are you sure you want to exit the test?')) {
                    window.location.href = '/patient';
                }
            }
        });

        // Auto-enable fullscreen
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (!document.fullscreenElement) {
                    const elem = document.documentElement;
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen().catch(err => {
                            console.log(`Fullscreen error: ${err.message}`);
                        });
                    }
                }
            }, 500);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV-1000 Contrast Sensitivity Test</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #000;
            color: white;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
        }

        .fullscreen-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .test-setup {
            text-align: center;
            max-width: 600px;
            padding: 40px;
        }

        .letter-display {
            font-size: 120px;
            font-weight: bold;
            margin: 40px 0;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .contrast-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
        }

        .controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 15px;
        }

        .controls.show {
            display: flex;
        }

        .btn {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }

        .btn:hover {
            transform: scale(1.05);
        }

        .test-complete {
            display: none;
            text-align: center;
        }

        .score-display {
            font-size: 48px;
            color: #28a745;
            margin: 20px 0;
        }

        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 4px;
            background: #007bff;
            transition: width 0.3s ease;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="progress-bar" id="progressBar"></div>

    <div class="contrast-info" id="contrastInfo" style="display: none;">
        <div>Trial: <span id="current-trial">0</span> / 20</div>
        <div>Contrast: <span id="current-contrast">100%</span></div>
        <div>Correct: <span id="correct-count">0</span></div>
    </div>

    <div class="fullscreen-container">
        <!-- Test Setup -->
        <div class="test-setup" id="testSetup">
            <h2><i class="fas fa-font"></i> CSV-1000 Contrast Sensitivity Test</h2>
            <p>This test evaluates your contrast sensitivity using letters at different contrast levels.</p>

            <div class="mb-4">
                <h5>Instructions:</h5>
                <ul class="text-start">
                    <li>Look at the center of the screen</li>
                    <li>Identify the letter displayed</li>
                    <li>Press the corresponding key on your keyboard</li>
                    <li>Letters will become fainter as the test progresses</li>
                    <li>Make your best guess even if uncertain</li>
                </ul>
            </div>

            <button class="btn btn-primary btn-lg" onclick="startTest()">
                <i class="fas fa-play"></i> Start Test
            </button>
            <button class="btn btn-warning btn-lg ms-3" onclick="exitTest()">
                <i class="fas fa-times"></i> Exit Test
            </button>
        </div>

        <!-- Test Content -->
        <div class="test-content" id="testContent" style="display: none;">
            <div class="letter-display" id="letterDisplay">A</div>
        </div>

        <!-- Test Complete -->
        <div class="test-complete" id="testComplete">
            <h2><i class="fas fa-check-circle"></i> Test Complete!</h2>
            <div class="score-display" id="finalScore">0%</div>
            <p>Contrast Threshold: <span id="contrastThreshold">0%</span></p>
            <p>Total Correct: <span id="totalCorrect">0</span> / <span id="totalTrials">0</span></p>

            <button class="btn btn-success" onclick="saveResults()">
                <i class="fas fa-save"></i> Save Results
            </button>
            <button class="btn btn-primary" onclick="backToTests()">
                <i class="fas fa-arrow-left"></i> Back to Tests
            </button>
        </div>
    </div>

    <div class="controls" id="controls">
        <button class="btn btn-warning" onclick="skipTrial()">
            <i class="fas fa-forward"></i> Skip
        </button>
        <button class="btn btn-danger" onclick="endTest()">
            <i class="fas fa-stop"></i> End Test
        </button>
    </div>

    <script>
        class CSV1000Test {
            constructor() {
                this.currentTrial = 0;
                this.totalTrials = 20;
                this.correctCount = 0;
                this.testData = [];
                this.startTime = new Date();
                this.patientName = localStorage.getItem('patientName') || 'Unknown';
                this.isTestActive = false;

                this.letters = ['C', 'D', 'H', 'K', 'N', 'O', 'R', 'S', 'V', 'Z'];
                this.contrastLevels = [100, 50, 25, 12.5, 6.25, 3.125, 1.56, 0.78, 0.39, 0.195];
            }

            start() {
                document.getElementById('testSetup').style.display = 'none';
                document.getElementById('testContent').style.display = 'block';
                document.getElementById('controls').classList.add('show');
                document.getElementById('contrastInfo').style.display = 'block';

                this.isTestActive = true;
                this.startTime = new Date();
                this.showNextTrial();
            }

            showNextTrial() {
                if (this.currentTrial >= this.totalTrials || !this.isTestActive) {
                    this.completeTest();
                    return;
                }

                // Select random letter and contrast
                const letter = this.letters[Math.floor(Math.random() * this.letters.length)];
                const contrastIndex = Math.min(this.currentTrial / 2, this.contrastLevels.length - 1);
                const contrast = this.contrastLevels[Math.floor(contrastIndex)];

                this.currentLetter = letter;
                this.currentContrast = contrast;
                this.trialStartTime = Date.now();

                // Update display
                const letterDisplay = document.getElementById('letterDisplay');
                letterDisplay.textContent = letter;
                letterDisplay.style.color = `rgba(255, 255, 255, ${contrast / 100})`;

                // Update info
                document.getElementById('current-trial').textContent = this.currentTrial + 1;
                document.getElementById('current-contrast').textContent = contrast.toFixed(2) + '%';
                document.getElementById('correct-count').textContent = this.correctCount;

                // Update progress
                const progress = ((this.currentTrial + 1) / this.totalTrials) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
            }

            handleKeyPress(event) {
                if (!this.isTestActive || !this.currentLetter) return;

                const pressedKey = event.key.toUpperCase();
                const reactionTime = Date.now() - this.trialStartTime;
                const isCorrect = pressedKey === this.currentLetter;

                if (isCorrect) {
                    this.correctCount++;
                }

                this.testData.push({
                    trial: this.currentTrial + 1,
                    letter: this.currentLetter,
                    contrast: this.currentContrast,
                    response: pressedKey,
                    correct: isCorrect,
                    reactionTime: reactionTime,
                    timestamp: new Date()
                });

                this.currentTrial++;
                setTimeout(() => this.showNextTrial(), 500);
            }

            skipTrial() {
                if (!this.isTestActive) return;

                this.testData.push({
                    trial: this.currentTrial + 1,
                    letter: this.currentLetter,
                    contrast: this.currentContrast,
                    response: 'SKIPPED',
                    correct: false,
                    reactionTime: 0,
                    timestamp: new Date()
                });

                this.currentTrial++;
                this.showNextTrial();
            }

            endTest() {
                if (confirm('Are you sure you want to end the test?')) {
                    this.isTestActive = false;
                    this.completeTest();
                }
            }

            completeTest() {
                this.isTestActive = false;
                document.getElementById('testContent').style.display = 'none';
                document.getElementById('testComplete').style.display = 'block';
                document.getElementById('controls').classList.remove('show');
                document.getElementById('contrastInfo').style.display = 'none';

                const accuracy = this.currentTrial > 0 ? (this.correctCount / this.currentTrial) * 100 : 0;
                const threshold = this.calculateContrastThreshold();

                document.getElementById('finalScore').textContent = accuracy.toFixed(1) + '%';
                document.getElementById('contrastThreshold').textContent = threshold.toFixed(2) + '%';
                document.getElementById('totalCorrect').textContent = this.correctCount;
                document.getElementById('totalTrials').textContent = this.currentTrial;

                document.getElementById('progressBar').style.width = '100%';
            }

            calculateContrastThreshold() {
                // Find lowest contrast where patient got 75% correct in last 4 trials
                let threshold = 100;
                for (let i = this.testData.length - 1; i >= Math.max(0, this.testData.length - 4); i--) {
                    if (this.testData[i].correct) {
                        threshold = Math.min(threshold, this.testData[i].contrast);
                    }
                }
                return threshold;
            }

            saveResults() {
                const endTime = new Date();
                const duration = Math.round((endTime - this.startTime) / 1000);

                const results = {
                    patient_name: this.patientName,
                    test_name: 'csv1000',
                    duration: duration,
                    start_time: this.startTime.toISOString(),
                    end_time: endTime.toISOString(),
                    total_points: this.currentTrial,
                    correct_points: this.correctCount,
                    accuracy: this.currentTrial > 0 ? (this.correctCount / this.currentTrial) * 100 : 0,
                    language: 'English',
                    contrast_levels: this.contrastLevels,
                    letter_accuracy: this.correctCount,
                    responses: this.testData,
                    contrast_threshold: this.calculateContrastThreshold()
                };

                fetch('/api/save_test_result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(results)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Test completed successfully! Returning to test dashboard...');
                        setTimeout(() => {
                            backToTests();
                        }, 1000);
                    } else {
                        alert('Error saving results: ' + data.message);
                        setTimeout(() => {
                            backToTests();
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error saving results:', error);
                    alert('Error saving results. Returning to dashboard...');
                    setTimeout(() => {
                        backToTests();
                    }, 2000);
                });
            }
        }

        let test = null;

        function startTest() {
            test = new CSV1000Test();
            test.start();
        }

        function skipTrial() {
            if (test) test.skipTrial();
        }

        function endTest() {
            if (test) test.endTest();
        }

        function saveResults() {
            if (test) test.saveResults();
        }

        function exitTest() {
            if (confirm('Are you sure you want to exit the test?')) {
                backToTests();
            }
        }

        function backToTests() {
            window.location.href = '/patient';
        }

        // Handle keyboard input
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                exitTest();
            } else if (test && test.isTestActive) {
                test.handleKeyPress(e);
            }
        });

        // Auto-enable fullscreen
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (!document.fullscreenElement) {
                    const elem = document.documentElement;
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen().catch(err => {
                            console.log(`Fullscreen error: ${err.message}`);
                        });
                    }
                }
            }, 500);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Detection Test</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #000;
            color: white;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .fullscreen-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .motion-canvas {
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: #111;
        }

        .test-setup {
            text-align: center;
            max-width: 600px;
            padding: 40px;
        }

        .controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 15px;
        }

        .controls.show {
            display: flex;
        }

        .btn {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }

        .test-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
        }

        .test-complete {
            display: none;
            text-align: center;
        }

        .score-display {
            font-size: 48px;
            color: #28a745;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="test-info" id="testInfo" style="display: none;">
        <div>Trial: <span id="current-trial">0</span> / 15</div>
        <div>Detected: <span id="detected-count">0</span></div>
        <div>Direction: <span id="motion-direction">-</span></div>
    </div>

    <div class="fullscreen-container">
        <!-- Test Setup -->
        <div class="test-setup" id="testSetup">
            <h2><i class="fas fa-running"></i> Motion Detection Test</h2>
            <p>This test evaluates your ability to detect motion in your peripheral vision.</p>

            <div class="mb-4">
                <h5>Instructions:</h5>
                <ul class="text-start">
                    <li>Keep your eyes focused on the center cross</li>
                    <li>Watch for moving dots in your peripheral vision</li>
                    <li>Click the direction buttons when you see motion</li>
                    <li>Use arrow keys: ← ↑ → ↓ for quick responses</li>
                </ul>
            </div>

            <button class="btn btn-primary btn-lg" onclick="startTest()">
                <i class="fas fa-play"></i> Start Test
            </button>
            <button class="btn btn-warning btn-lg ms-3" onclick="exitTest()">
                <i class="fas fa-times"></i> Exit Test
            </button>
        </div>

        <!-- Test Content -->
        <div class="test-content" id="testContent" style="display: none;">
            <canvas id="motionCanvas" class="motion-canvas" width="800" height="600"></canvas>
        </div>

        <!-- Test Complete -->
        <div class="test-complete" id="testComplete">
            <h2><i class="fas fa-check-circle"></i> Test Complete!</h2>
            <div class="score-display" id="finalScore">0%</div>
            <p>Motion Sensitivity: <span id="motionSensitivity">Normal</span></p>
            <p>Total Detected: <span id="totalDetected">0</span> / <span id="totalTrials">0</span></p>

            <button class="btn btn-success" onclick="saveResults()">
                <i class="fas fa-save"></i> Save Results
            </button>
            <button class="btn btn-primary" onclick="backToTests()">
                <i class="fas fa-arrow-left"></i> Back to Tests
            </button>
        </div>
    </div>

    <div class="controls" id="controls">
        <button class="btn btn-primary" onclick="selectDirection('left')">← Left</button>
        <button class="btn btn-primary" onclick="selectDirection('up')">↑ Up</button>
        <button class="btn btn-primary" onclick="selectDirection('right')">→ Right</button>
        <button class="btn btn-primary" onclick="selectDirection('down')">↓ Down</button>
        <button class="btn btn-warning" onclick="skipTrial()">Skip</button>
        <button class="btn btn-danger" onclick="endTest()">End</button>
    </div>

    <script>
        class MotionDetectionTest {
            constructor() {
                this.currentTrial = 0;
                this.totalTrials = 15;
                this.detectedCount = 0;
                this.testData = [];
                this.startTime = new Date();
                this.patientName = localStorage.getItem('patientName') || 'Unknown';
                this.isTestActive = false;
                this.canvas = null;
                this.ctx = null;
                this.animationId = null;
                this.currentDirection = '';
                this.trialStartTime = 0;
                this.dots = [];
            }

            start() {
                document.getElementById('testSetup').style.display = 'none';
                document.getElementById('testContent').style.display = 'block';
                document.getElementById('controls').classList.add('show');
                document.getElementById('testInfo').style.display = 'block';

                this.canvas = document.getElementById('motionCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.isTestActive = true;
                this.startTime = new Date();
                this.showNextTrial();
            }

            showNextTrial() {
                if (this.currentTrial >= this.totalTrials || !this.isTestActive) {
                    this.completeTest();
                    return;
                }

                // Clear canvas
                this.ctx.fillStyle = '#111';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw center fixation point
                this.ctx.fillStyle = 'red';
                this.ctx.fillRect(this.canvas.width/2 - 5, this.canvas.height/2 - 5, 10, 10);

                // Choose random direction
                const directions = ['left', 'right', 'up', 'down'];
                this.currentDirection = directions[Math.floor(Math.random() * directions.length)];
                this.trialStartTime = Date.now();

                // Create moving dots
                this.createMovingDots();
                this.animateMotion();

                // Update UI
                document.getElementById('current-trial').textContent = this.currentTrial + 1;
                document.getElementById('detected-count').textContent = this.detectedCount;
                document.getElementById('motion-direction').textContent = '-';
            }

            createMovingDots() {
                this.dots = [];
                const numDots = 20;

                for (let i = 0; i < numDots; i++) {
                    let x, y, vx, vy;

                    // Position dots based on direction
                    switch (this.currentDirection) {
                        case 'left':
                            x = this.canvas.width - 50;
                            y = Math.random() * this.canvas.height;
                            vx = -2;
                            vy = 0;
                            break;
                        case 'right':
                            x = 50;
                            y = Math.random() * this.canvas.height;
                            vx = 2;
                            vy = 0;
                            break;
                        case 'up':
                            x = Math.random() * this.canvas.width;
                            y = this.canvas.height - 50;
                            vx = 0;
                            vy = -2;
                            break;
                        case 'down':
                            x = Math.random() * this.canvas.width;
                            y = 50;
                            vx = 0;
                            vy = 2;
                            break;
                    }

                    this.dots.push({ x, y, vx, vy });
                }
            }

            animateMotion() {
                if (!this.isTestActive) return;

                // Clear canvas
                this.ctx.fillStyle = '#111';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw center fixation point
                this.ctx.fillStyle = 'red';
                this.ctx.fillRect(this.canvas.width/2 - 5, this.canvas.height/2 - 5, 10, 10);

                // Update and draw dots
                this.ctx.fillStyle = 'white';
                for (let dot of this.dots) {
                    dot.x += dot.vx;
                    dot.y += dot.vy;

                    if (dot.x > 0 && dot.x < this.canvas.width && 
                        dot.y > 0 && dot.y < this.canvas.height) {
                        this.ctx.beginPath();
                        this.ctx.arc(dot.x, dot.y, 2, 0, 2 * Math.PI);
                        this.ctx.fill();
                    }
                }

                // Continue animation for 2 seconds
                if (Date.now() - this.trialStartTime < 2000) {
                    this.animationId = requestAnimationFrame(() => this.animateMotion());
                } else {
                    // Auto-advance if no response
                    setTimeout(() => {
                        if (this.currentTrial === this.testData.length) {
                            this.recordResponse('none');
                        }
                    }, 500);
                }
            }

            selectDirection(direction) {
                if (!this.isTestActive || this.currentTrial !== this.testData.length) return;

                cancelAnimationFrame(this.animationId);
                this.recordResponse(direction);
            }

            recordResponse(response) {
                const reactionTime = Date.now() - this.trialStartTime;
                const isCorrect = response === this.currentDirection;

                if (isCorrect) {
                    this.detectedCount++;
                }

                this.testData.push({
                    trial: this.currentTrial + 1,
                    direction: this.currentDirection,
                    response: response,
                    correct: isCorrect,
                    reactionTime: reactionTime,
                    timestamp: new Date()
                });

                this.currentTrial++;
                setTimeout(() => this.showNextTrial(), 1000);
            }

            skipTrial() {
                if (!this.isTestActive) return;
                cancelAnimationFrame(this.animationId);
                this.recordResponse('skipped');
            }

            endTest() {
                if (confirm('Are you sure you want to end the test?')) {
                    this.isTestActive = false;
                    cancelAnimationFrame(this.animationId);
                    this.completeTest();
                }
            }

            completeTest() {
                this.isTestActive = false;
                document.getElementById('testContent').style.display = 'none';
                document.getElementById('testComplete').style.display = 'block';
                document.getElementById('controls').classList.remove('show');
                document.getElementById('testInfo').style.display = 'none';

                const accuracy = this.currentTrial > 0 ? (this.detectedCount / this.currentTrial) * 100 : 0;
                const sensitivity = accuracy > 75 ? 'High' : accuracy > 50 ? 'Normal' : 'Low';

                document.getElementById('finalScore').textContent = accuracy.toFixed(1) + '%';
                document.getElementById('motionSensitivity').textContent = sensitivity;
                document.getElementById('totalDetected').textContent = this.detectedCount;
                document.getElementById('totalTrials').textContent = this.currentTrial;
            }

            saveResults() {
                const endTime = new Date();
                const duration = Math.round((endTime - this.startTime) / 1000);

                const results = {
                    patient_name: this.patientName,
                    test_name: 'motion',
                    duration: duration,
                    start_time: this.startTime.toISOString(),
                    end_time: endTime.toISOString(),
                    total_points: this.currentTrial,
                    correct_points: this.detectedCount,
                    accuracy: this.currentTrial > 0 ? (this.detectedCount / this.currentTrial) * 100 : 0,
                    responses: this.testData,
                    motion_detection_data: {
                        sensitivity: document.getElementById('motionSensitivity').textContent,
                        directions_tested: this.testData.map(d => d.direction)
                    }
                };

                fetch('/api/save_test_result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(results)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Test completed successfully! Returning to test dashboard...');
                        setTimeout(() => {
                            backToTests();
                        }, 1000);
                    } else {
                        alert('Error saving results: ' + data.message);
                        setTimeout(() => {
                            backToTests();
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error saving results:', error);
                    alert('Error saving results. Returning to dashboard...');
                    setTimeout(() => {
                        backToTests();
                    }, 2000);
                });
            }
        }

        let test = null;

        function startTest() {
            test = new MotionDetectionTest();
            test.start();
        }

        function selectDirection(direction) {
            if (test) test.selectDirection(direction);
        }

        function skipTrial() {
            if (test) test.skipTrial();
        }

        function endTest() {
            if (test) test.endTest();
        }

        function saveResults() {
            if (test) test.saveResults();
        }

        function exitTest() {
            if (confirm('Are you sure you want to exit the test?')) {
                backToTests();
            }
        }

        function backToTests() {
            window.location.href = '/patient';
        }

        // Handle keyboard input
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                exitTest();
            } else if (test && test.isTestActive) {
                switch(e.key) {
                    case 'ArrowLeft':
                        test.selectDirection('left');
                        break;
                    case 'ArrowRight':
                        test.selectDirection('right');
                        break;
                    case 'ArrowUp':
                        test.selectDirection('up');
                        break;
                    case 'ArrowDown':
                        test.selectDirection('down');
                        break;
                }
            }
        });

        // Auto-enable fullscreen
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (!document.fullscreenElement) {
                    const elem = document.documentElement;
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen().catch(err => {
                            console.log(`Fullscreen error: ${err.message}`);
                        });
                    }
                }
            }, 500);
        });
    </script>
</body>
</html>
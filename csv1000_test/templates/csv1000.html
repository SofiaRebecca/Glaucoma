<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV-1000 Test</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #000;
            color: white;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        
        .test-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .letter-display {
            font-family: 'Courier New', monospace;
            font-size: 120px;
            font-weight: bold;
            margin-bottom: 40px;
            user-select: none;
            filter: contrast(1);
            transition: filter 0.3s ease;
        }
        
        .options-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .option-btn {
            min-width: 80px;
            min-height: 80px;
            font-size: 36px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .instructions {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 10px;
            max-width: 600px;
        }
        
        .language-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .test-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .exit-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .contrast-info {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="instructions" class="instructions">
        <h2 class="mb-4">
            <i class="fas fa-font me-2"></i>
            CSV-1000 Contrast Sensitivity Test
        </h2>
        <p class="mb-4">
            This test measures your ability to detect letters at different contrast levels.
        </p>
        <div class="mb-4">
            <h5>Instructions:</h5>
            <ul class="text-start">
                <li>A letter will appear on the screen at varying contrast levels</li>
                <li>Click on the button that matches the letter you see</li>
                <li>If you cannot see the letter clearly, make your best guess</li>
                <li>The test will gradually reduce contrast to find your threshold</li>
            </ul>
        </div>
        <div class="mb-4">
            <h6>Select Language:</h6>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" id="english-btn" onclick="setLanguage('english')">English</button>
                <button type="button" class="btn btn-outline-primary" id="kannada-btn" onclick="setLanguage('kannada')">ಕನ್ನಡ</button>
            </div>
        </div>
        <button class="btn btn-primary btn-lg" onclick="startTest()" id="start-btn" disabled>
            <i class="fas fa-play me-2"></i>
            Start Test
        </button>
    </div>
    
    <div id="test-container" class="test-container" style="display: none;">
        <div class="test-info">
            <div>Letter: <span id="current-letter">0</span> / 48</div>
            <div>Correct: <span id="correct-count">0</span></div>
            <div>Language: <span id="current-language">English</span></div>
        </div>
        
        <div class="language-toggle">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-light btn-sm" id="test-english-btn" onclick="switchLanguage('english')">English</button>
                <button type="button" class="btn btn-outline-light btn-sm" id="test-kannada-btn" onclick="switchLanguage('kannada')">ಕನ್ನಡ</button>
            </div>
        </div>
        
        <div id="letter-display" class="letter-display">C</div>
        
        <div class="options-container" id="options-container">
            <!-- Options will be generated dynamically -->
        </div>
        
        <div class="contrast-info">
            Contrast Level: <span id="contrast-level">100%</span>
        </div>
        
        <button class="exit-btn" onclick="exitTest()">
            <i class="fas fa-times"></i> Exit
        </button>
    </div>

    <script>
        class CSV1000Test {
            constructor() {
                this.patientName = localStorage.getItem('patientName') || 'Unknown';
                this.startTime = null;
                this.currentLetterIndex = 0;
                this.totalLetters = 48; // 8 letters × 6 contrast levels
                this.correctCount = 0;
                this.responses = [];
                this.currentLanguage = 'english';
                this.testStartTime = null;
                
                // Letter sets for both languages
                this.letterSets = {
                    english: ['C', 'D', 'H', 'K', 'N', 'O', 'R', 'S'],
                    kannada: ['ಅ', 'ಆ', 'ಇ', 'ಈ', 'ಉ', 'ಊ', 'ಎ', 'ಏ']
                };
                
                // Contrast levels (percentage)
                this.contrastLevels = [100, 50, 25, 12.5, 6.25, 3.125];
                this.currentContrastIndex = 0;
                this.currentLetterSet = 0;
                
                // Generate test sequence
                this.generateTestSequence();
            }
            
            generateTestSequence() {
                this.testSequence = [];
                
                for (let contrast of this.contrastLevels) {
                    for (let letter of this.letterSets[this.currentLanguage]) {
                        this.testSequence.push({
                            letter: letter,
                            contrast: contrast,
                            options: this.generateOptions(letter)
                        });
                    }
                }
                
                // Shuffle the sequence
                this.shuffleArray(this.testSequence);
            }
            
            generateOptions(correctLetter) {
                const letterSet = this.letterSets[this.currentLanguage];
                const options = [correctLetter];
                
                // Add 3 random incorrect options
                while (options.length < 4) {
                    const randomLetter = letterSet[Math.floor(Math.random() * letterSet.length)];
                    if (!options.includes(randomLetter)) {
                        options.push(randomLetter);
                    }
                }
                
                // Shuffle options
                this.shuffleArray(options);
                return options;
            }
            
            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }
            
            setLanguage(language) {
                this.currentLanguage = language;
                
                // Update button states
                document.getElementById('english-btn').className = 
                    language === 'english' ? 'btn btn-primary' : 'btn btn-outline-primary';
                document.getElementById('kannada-btn').className = 
                    language === 'kannada' ? 'btn btn-primary' : 'btn btn-outline-primary';
                
                // Enable start button
                document.getElementById('start-btn').disabled = false;
                
                // Regenerate test sequence with new language
                this.generateTestSequence();
            }
            
            switchLanguage(language) {
                if (language === this.currentLanguage) return;
                
                this.currentLanguage = language;
                
                // Update display
                document.getElementById('current-language').textContent = 
                    language === 'english' ? 'English' : 'ಕನ್ನಡ';
                
                // Update button states
                document.getElementById('test-english-btn').className = 
                    language === 'english' ? 'btn btn-light btn-sm' : 'btn btn-outline-light btn-sm';
                document.getElementById('test-kannada-btn').className = 
                    language === 'kannada' ? 'btn btn-light btn-sm' : 'btn btn-outline-light btn-sm';
                
                // Regenerate remaining test sequence
                this.generateTestSequence();
                this.currentLetterIndex = 0;
                this.showCurrentLetter();
            }
            
            start() {
                document.getElementById('instructions').style.display = 'none';
                document.getElementById('test-container').style.display = 'flex';
                this.startTime = new Date();
                this.showCurrentLetter();
            }
            
            showCurrentLetter() {
                if (this.currentLetterIndex >= this.testSequence.length) {
                    this.completeTest();
                    return;
                }
                
                const currentTest = this.testSequence[this.currentLetterIndex];
                this.testStartTime = Date.now();
                
                // Update display
                document.getElementById('current-letter').textContent = this.currentLetterIndex + 1;
                document.getElementById('correct-count').textContent = this.correctCount;
                document.getElementById('contrast-level').textContent = currentTest.contrast + '%';
                
                // Show letter with contrast
                const letterDisplay = document.getElementById('letter-display');
                letterDisplay.textContent = currentTest.letter;
                letterDisplay.style.filter = `contrast(${currentTest.contrast / 100})`;
                
                // Generate option buttons
                this.showOptions(currentTest.options, currentTest.letter);
            }
            
            showOptions(options, correctLetter) {
                const container = document.getElementById('options-container');
                container.innerHTML = '';
                
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'btn btn-outline-light option-btn';
                    button.textContent = option;
                    button.onclick = () => this.handleResponse(option, correctLetter);
                    container.appendChild(button);
                });
            }
            
            handleResponse(selectedLetter, correctLetter) {
                const responseTime = Date.now() - this.testStartTime;
                const isCorrect = selectedLetter === correctLetter;
                const currentTest = this.testSequence[this.currentLetterIndex];
                
                if (isCorrect) {
                    this.correctCount++;
                }
                
                // Record response
                this.responses.push({
                    letterIndex: this.currentLetterIndex,
                    correctLetter: correctLetter,
                    selectedLetter: selectedLetter,
                    isCorrect: isCorrect,
                    contrastLevel: currentTest.contrast,
                    language: this.currentLanguage,
                    responseTime: responseTime,
                    timestamp: new Date()
                });
                
                // Provide visual feedback
                const buttons = document.querySelectorAll('.option-btn');
                buttons.forEach(btn => {
                    if (btn.textContent === correctLetter) {
                        btn.className = 'btn btn-success option-btn';
                    } else if (btn.textContent === selectedLetter && !isCorrect) {
                        btn.className = 'btn btn-danger option-btn';
                    }
                    btn.disabled = true;
                });
                
                // Move to next letter after delay
                setTimeout(() => {
                    this.currentLetterIndex++;
                    this.showCurrentLetter();
                }, 1000);
            }
            
            completeTest() {
                const endTime = new Date();
                const duration = Math.round((endTime - this.startTime) / 1000);
                
                // Calculate contrast levels achieved
                const contrastLevels = this.responses.map(r => r.contrastLevel);
                const letterAccuracy = Math.round((this.correctCount / this.responses.length) * 100);
                
                const testData = {
                    patient_name: this.patientName,
                    duration: duration,
                    total_points: this.responses.length,
                    correct_points: this.correctCount,
                    language: this.currentLanguage,
                    contrast_levels: contrastLevels,
                    letter_accuracy: letterAccuracy,
                    start_time: this.startTime.toLocaleTimeString(),
                    end_time: endTime.toLocaleTimeString(),
                    responses: this.responses
                };
                
                // Save results
                this.saveResults(testData);
                
                // Show results
                this.showResults(testData);
            }
            
            saveResults(data) {
                fetch('/api/save_result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    console.log('Results saved:', result);
                })
                .catch(error => {
                    console.error('Error saving results:', error);
                });
            }
            
            showResults(data) {
                const minContrast = Math.min(...data.contrast_levels.filter((_, i) => this.responses[i].isCorrect));
                const maxContrast = Math.max(...data.contrast_levels.filter((_, i) => this.responses[i].isCorrect));
                
                document.body.innerHTML = `
                    <div class="container-fluid min-vh-100 d-flex align-items-center justify-content-center">
                        <div class="text-center">
                            <div class="mb-4">
                                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                                <h2>CSV-1000 Test Completed</h2>
                            </div>
                            
                            <div class="card bg-dark border-secondary mx-auto" style="max-width: 600px;">
                                <div class="card-body">
                                    <h5 class="card-title">Test Results</h5>
                                    <hr>
                                    <div class="row text-center mb-3">
                                        <div class="col-3">
                                            <h3 class="text-primary">${data.letter_accuracy}%</h3>
                                            <small>Letter Accuracy</small>
                                        </div>
                                        <div class="col-3">
                                            <h3 class="text-info">${data.duration}s</h3>
                                            <small>Duration</small>
                                        </div>
                                        <div class="col-3">
                                            <h3 class="text-success">${data.correct_points}/${data.total_points}</h3>
                                            <small>Score</small>
                                        </div>
                                        <div class="col-3">
                                            <h3 class="text-warning">${minContrast.toFixed(1)}%</h3>
                                            <small>Min Contrast</small>
                                        </div>
                                    </div>
                                    
                                    <div class="text-start">
                                        <h6>Contrast Sensitivity Analysis:</h6>
                                        <p class="text-muted">
                                            Language: ${data.language === 'english' ? 'English' : 'Kannada'}<br>
                                            Lowest detectable contrast: ${minContrast.toFixed(1)}%<br>
                                            ${minContrast < 10 ? 
                                                'Excellent contrast sensitivity detected.' :
                                                minContrast < 25 ?
                                                'Good contrast sensitivity.' :
                                                'Reduced contrast sensitivity detected. Consider follow-up evaluation.'
                                            }
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button class="btn btn-primary btn-lg me-3" onclick="window.location.href='http://${window.location.hostname}:8000/patient'">
                                    <i class="fas fa-arrow-left me-2"></i>
                                    Back to Tests
                                </button>
                                <button class="btn btn-success btn-lg" onclick="location.reload()">
                                    <i class="fas fa-redo me-2"></i>
                                    Retake Test
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        let test = null;
        
        function setLanguage(language) {
            if (!test) {
                test = new CSV1000Test();
            }
            test.setLanguage(language);
        }
        
        function switchLanguage(language) {
            if (test) {
                test.switchLanguage(language);
            }
        }
        
        function startTest() {
            if (!test) {
                test = new CSV1000Test();
            }
            test.start();
        }
        
        function exitTest() {
            if (confirm('Are you sure you want to exit this test?')) {
                window.location.href = 'http://' + window.location.hostname + ':8000/patient';
            }
        }
        
        // Handle keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                exitTest();
            } else if (e.key >= '1' && e.key <= '4' && test) {
                const options = document.querySelectorAll('.option-btn');
                if (options[parseInt(e.key) - 1]) {
                    options[parseInt(e.key) - 1].click();
                }
            }
        });
    </script>
</body>
</html>
